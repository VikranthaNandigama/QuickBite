<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickBite | Canteen Management System (Modern Design)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="icon" href="titt.png">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Light, sophisticated background */
            background-color: #f8fafc; /* Slate 50 or Zink 50 */
        }
        
        /* Modern Primary Theme - Emerald (Green) */
        .canteen-primary {
            background-color: #059669; /* Emerald 600 */
        }
        .hover-canteen-primary:hover {
            background-color: #047857; /* Emerald 700 */
        }
        .text-canteen-primary {
            color: #059669;
        }
        .focus-canteen-primary:focus {
             border-color: #059669;
             --tw-ring-color: #059669;
        }
        .focus\:ring-canteen-primary:focus {
             --tw-ring-color: #059669;
        }
        .focus\:border-canteen-primary:focus {
             border-color: #059669;
        }
        
        /* Utility for image fallbacks (Enhanced for visibility) */
        .img-fallback {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #d9f99d; /* Lime 200 */
            color: #1a2e05; /* Darker Lime */
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1.25;
            padding: 4px;
        }

        /* General element transitions */
        .transition-all-smooth {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Enable native smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen flex flex-col">
        
        <header class="bg-white shadow-lg sticky top-0 z-20">
            <div class="max-w-7xl mx-auto p-4 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <img src="logo.jpg" 
                         alt="QuickBite Canteen Logo" 
                         class="h-16 w-auto" 
                         onerror="this.onerror=null; this.src='https://placehold.co/150x40/059669/ffffff?text=QuickBite+Canteen';"
                    >
                    <h1 class="text-2xl font-extrabold text-gray-800 hidden sm:block"></h1>
                </div>
                
                <nav class="flex items-center space-x-6">
                    <a href="#student-menu-section" id="nav-menu-link" 
                       class="text-gray-600 hover:text-canteen-primary font-bold hidden transition-all-smooth text-base flex items-center">
                        <i data-lucide="utensils" class="w-5 h-5 mr-1"></i> Menu
                    </a>

                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600 hidden sm:block">Access View:</span>
                        <select id="role-switcher" onchange="QuickBite.switchRole(this.value)"
                                class="p-2 border border-gray-300 rounded-xl text-sm bg-white shadow-inner focus:ring-2 focus:ring-canteen-primary focus:border-canteen-primary transition-all-smooth">
                            <option value="student">Student</option>
                            <option value="staff">Staff</option>
                        </select>
                        <button onclick="QuickBite.toggleDebugInfo()" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition duration-300">
                            <i data-lucide="info" class="w-5 h-5 text-gray-500"></i>
                        </button>
                    </div>
                </nav>

            </div>
        </header>

        <div id="debug-info" class="bg-gray-900 text-white p-3 text-sm hidden">
            <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between">
                <span>LOCAL User ID: <span id="debug-user-id" class="font-mono text-amber-400"></span></span>
                <span id="debug-storage-status">Storage: Local Storage Used</span>
            </div>
        </div>

        <main class="flex-grow max-w-7xl mx-auto w-full p-4 grid gap-8" id="main-content-area">
            </main>
    </div>

    <div id="prepTimeModal" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full border-t-8 border-canteen-primary transition-all-smooth transform scale-100">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Set Preparation Time</h2>
            <p class="mb-4 text-gray-600">Order ID: <span id="modalOrderIdDisplay" class="font-mono font-semibold text-canteen-primary"></span></p>

            <input type="hidden" id="modalOrderId" value="">
            
            <input type="number" id="prepTimeInput" placeholder="Time in minutes (e.g., 10)" required min="1" 
                   class="w-full p-3 mb-6 rounded-xl border border-gray-300 focus:ring-2 focus-canteen-primary focus:border-canteen-primary transition-all-smooth">
            
            <div class="flex justify-end space-x-3">
                <button onclick="QuickBite.hidePrepTimeModal()" class="text-gray-600 hover:bg-gray-100 font-medium py-2 px-4 rounded-xl transition duration-200">
                    Cancel
                </button>
                <button id="modalConfirmPrepTime" onclick="QuickBite.handlePrepTimeSubmission()" 
                        class="canteen-primary hover-canteen-primary text-white font-bold py-2 px-4 rounded-xl transition-all-smooth shadow-lg hover:shadow-xl transform hover:scale-[1.01]">
                    Confirm Time
                </button>
            </div>
        </div>
    </div>

    <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-60 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center border-t-8 border-canteen-primary transition-all-smooth">
            <p id="messageText" class="text-xl font-semibold mb-6 text-gray-700">Message Content</p>
            <button onclick="QuickBite.hideMessageBox()" 
                    class="canteen-primary hover-canteen-primary text-white font-bold py-2 px-4 rounded-xl transition-all-smooth shadow-lg hover:shadow-xl">
                OK
            </button>
        </div>
    </div>
<script type="text/javascript">
        
        // --- Global Constants ---
        const LS_KEY_MENU = 'quickbite_menu';
        const LS_KEY_ORDERS = 'quickbite_orders';
        const LS_KEY_USER_ID = 'quickbite_local_user_id';
        const LS_KEY_ROLE = 'quickbite_role';
        const LS_KEY_FEEDBACK = 'quickbite_feedback'; 
        const CURRENCY_SYMBOL = '₹'; // Indian Rupee
        
        // New constants for Order ID logic
        const LS_KEY_ORDER_DATE = 'quickbite_last_order_date';
        const LS_KEY_ORDER_NUM = 'quickbite_last_order_num';

        // Initial menu data - Vegetarian, with placeholder images added
        // ADDED: isAvailable property to all initial items
        const INITIAL_MENU = [
            { id: 'm1', name: 'Veggie Burger', price: 120.00, description: 'Classic patty with fresh veggies.', category: 'Snacks', imageUrl: 'https://placehold.co/100x100/34D399/047857?text=Burger', isAvailable: true },
            { id: 'm3', name: 'French Fries', price: 60.00, description: 'Crispy, salted fries.', category: 'Snacks', imageUrl: 'https://placehold.co/100x100/FBBF24/92400E?text=Fries', isAvailable: true },
            { id: 'm4', name: 'Cola', price: 40.00, description: 'Cold Coca-Cola.', category: 'Drinks', imageUrl: 'https://placehold.co/100x100/67E8F9/064E3B?text=Cola', isAvailable: true },
            { id: 'm5', name: 'Chocolate Brownie', price: 80.00, description: 'Warm chocolate brownie.', category: 'Dessert', imageUrl: 'https://placehold.co/100x100/A78BFA/3730A3?text=Brownie', isAvailable: true },
            { id: 'm6', name: 'Veg Gujarati Meal', price: 200.00, description: 'Seasonal vegetables, roti, dal, rice, and buttermilk.', category: 'Meals', imageUrl: 'https://placehold.co/100x100/FDBA74/9A3412?text=Meal', isAvailable: true },
            { id: 'm7', name: 'Paneer Tikka Roll', price: 130.00, description: 'Soft paneer marinated in tikka spices, wrapped in a roti.', category: 'Snacks', imageUrl: 'https://placehold.co/100x100/D1FAE5/064E3B?text=Paneer+Roll', isAvailable: true },
            { id: 'm8', name: 'Masala Dosa', price: 100.00, description: 'Crispy rice pancake with spicy potato filling and sambar.', category: 'Breakfast', imageUrl: 'https://placehold.co/100x100/FEF9C3/854D0E?text=Dosa', isAvailable: true },
            { id: 'm9', name: 'Aloo Paratha (2 Pcs)', price: 90.00, description: 'Whole wheat flatbreads stuffed with spiced mashed potato, served with pickle.', category: 'Breakfast', imageUrl: 'https://placehold.co/100x100/FBCFE8/831843?text=Paratha', isAvailable: true },
            { id: 'm10', name: 'Fresh Lime Soda', price: 50.00, description: 'Refreshing sweet and salty soda.', category: 'Drinks', imageUrl: 'https://placehold.co/100x100/A7F3D0/064E3B?text=Lime+Soda', isAvailable: true },
            { id: 'm11', name: 'Fruit Custard', price: 70.00, description: 'Chilled custard with mixed fresh fruits.', category: 'Dessert', imageUrl: 'https://placehold.co/100x100/FBCFE8/831843?text=Custard', isAvailable: true },
            { id: 'm12', name: 'Pav Bhaji', price: 140.00, description: 'Spicy vegetable curry served with soft buttered bread rolls.', category: 'Snacks', imageUrl: 'https://placehold.co/100x100/FCA5A5/7F1D1D?text=Pav+Bhaji', isAvailable: true },
            { id: 'm13', name: 'Lemon Rice', price: 110.00, description: 'Fluffy rice tempered with lemon juice and peanuts.', category: 'Meals', imageUrl: 'https://placehold.co/100x100/FDE68A/B45309?text=Lemon+Rice', isAvailable: true }
        ];

        // --- Utility Functions ---
        
        // Simple ID generator (replaces Firestore auto-ID) - Used for User ID only
        function generateUniqueId() {
            return 'id-' + Date.now().toString(36) + Math.random().toString(36).substring(2, 5);
        }
        
        // Function to generate date-based sequential order ID (YYMMDDNN)
        function generateNextOrderID() {
            const now = new Date();
            const YY = now.getFullYear().toString().substring(2); // YY (e.g., 25)
            const MM = String(now.getMonth() + 1).padStart(2, '0'); // MM
            const DD = String(now.getDate()).padStart(2, '0'); // DD
            const todayDate = YY + MM + DD; // e.g., 251122

            let lastOrderDate = localStorage.getItem(LS_KEY_ORDER_DATE);
            let lastOrderNum = parseInt(localStorage.getItem(LS_KEY_ORDER_NUM) || '0', 10);
            
            let currentOrderNum;

            if (lastOrderDate === todayDate) {
                // Same day, increment number
                currentOrderNum = lastOrderNum + 1;
            } else {
                // New day, reset number
                currentOrderNum = 1;
                localStorage.setItem(LS_KEY_ORDER_DATE, todayDate);
            }
            
            // Save the new number
            localStorage.setItem(LS_KEY_ORDER_NUM, currentOrderNum.toString());

            // Format the sequential number (NN)
            // Note: This implementation supports numbers 01 to 99, then continues with 100, 101, etc.
            const orderNumStr = String(currentOrderNum).padStart(2, '0'); 

            // Combine: YYMMDDNN (or more digits if order count > 99)
            return todayDate + orderNumStr;
        }

        // --- Global State Management for QuickBite ---
        window.QuickBite = {
            menu: [],
            cart: [],
            orders: [],
            feedback: [], 
            userId: null,
            userRole: localStorage.getItem(LS_KEY_ROLE) || 'student', // Default role

            // --- Utility UI Functions ---

            showMessageBox(message) {
                document.getElementById('messageText').textContent = message;
                document.getElementById('messageBox').classList.remove('hidden');
                document.getElementById('messageBox').classList.add('flex');
            },

            hideMessageBox() {
                document.getElementById('messageBox').classList.add('hidden');
                document.getElementById('messageBox').classList.remove('flex');
            },

            toggleDebugInfo() {
                document.getElementById('debug-info').classList.toggle('hidden');
            },

            updateDebugInfo() {
                document.getElementById('debug-user-id').textContent = this.userId || 'N/A';
            },

            // --- Local Storage Persistence ---

            loadData() {
                // Load User ID (uses old generic ID generator)
                let storedId = localStorage.getItem(LS_KEY_USER_ID);
                if (!storedId) {
                    storedId = generateUniqueId();
                    localStorage.setItem(LS_KEY_USER_ID, storedId);
                }
                this.userId = storedId;

                // Load Menu
                const storedMenu = localStorage.getItem(LS_KEY_MENU);
                let loadedMenu = storedMenu ? JSON.parse(storedMenu) : [];

                // Check for updates: If a new item (like m13) is missing, or the new property is missing, re-initialize/update
                const needsUpdate = loadedMenu.length < INITIAL_MENU.length || 
                                    !loadedMenu.find(item => item.id === 'm13') ||
                                    (loadedMenu.length > 0 && loadedMenu.findIndex(item => item.isAvailable === undefined) !== -1);
                
                if (needsUpdate) {
                    // Simple re-initialization:
                    this.menu = INITIAL_MENU;
                    this.saveMenu();
                } else {
                    this.menu = loadedMenu;
                }

                // Load Orders
                const storedOrders = localStorage.getItem(LS_KEY_ORDERS);
                this.orders = storedOrders ? JSON.parse(storedOrders) : [];

                // Load Feedback
                const storedFeedback = localStorage.getItem(LS_KEY_FEEDBACK);
                this.feedback = storedFeedback ? JSON.parse(storedFeedback) : []; 

                this.updateDebugInfo();
            },

            saveMenu() {
                localStorage.setItem(LS_KEY_MENU, JSON.stringify(this.menu));
            },

            saveOrders() {
                localStorage.setItem(LS_KEY_ORDERS, JSON.stringify(this.orders));
            },
            
            saveFeedback() { 
                localStorage.setItem(LS_KEY_FEEDBACK, JSON.stringify(this.feedback));
            },

            // --- Role Switching ---

            switchRole(newRole) {
                this.userRole = newRole;
                localStorage.setItem(LS_KEY_ROLE, newRole);
                document.getElementById('role-switcher').value = newRole;
                this.renderApp();
            },

            // --- Initialization ---

            initApp() {
                this.loadData();
                document.getElementById('role-switcher').value = this.userRole;
                this.renderApp();
            },

            // --- Student Side Logic ---

            addToCart(itemId) {
                const item = this.menu.find(i => i.id === itemId);
                // ADDED: Check for availability before adding to cart
                if (!item || !item.isAvailable) {
                    this.showMessageBox(`${item ? item.name : 'Item'} is currently **sold out** and cannot be added to your cart.`);
                    return;
                }

                const existingItem = this.cart.find(c => c.id === itemId);
                if (existingItem) {
                    existingItem.qty += 1;
                } else {
                    this.cart.push({ ...item, qty: 1 });
                }
                this.renderCart();
            },

            updateCartItem(itemId, change) {
                const item = this.cart.find(c => c.id === itemId);
                if (!item) return;

                item.qty += change;

                if (item.qty <= 0) {
                    this.cart = this.cart.filter(c => c.id !== itemId);
                }
                this.renderCart();
            },

            placeOrder() {
                if (this.cart.length === 0) {
                    this.showMessageBox("Your cart is empty. Please add items to place an order.");
                    return;
                }
                
                // ADDED: Check cart items for availability at checkout (as a double-check)
                const unavailableItems = this.cart.filter(cartItem => {
                    const menuItem = this.menu.find(m => m.id === cartItem.id);
                    return !menuItem || !menuItem.isAvailable;
                });

                if (unavailableItems.length > 0) {
                     const itemNames = unavailableItems.map(item => item.name).join(', ');
                     this.showMessageBox(`Cannot place order: The following item(s) are now **sold out**: ${itemNames}. Please remove them from your cart.`);
                     this.renderCart();
                     this.renderMenu(this.menu); // Re-render menu to show sold out status
                     return;
                }


                const total = this.cart.reduce((sum, item) => sum + item.price * item.qty, 0);
                
                // --- MODIFICATION START: Simulate Razorpay Redirect/Payment Bypass ---
                console.log(`[PAYMENT SIMULATION]: Redirect to Razorpay for ${CURRENCY_SYMBOL}${total.toFixed(2)}. Bypassing payment and proceeding to order placement.`);
                // --- MODIFICATION END ---

                // Use the new date-based sequential order ID generator
                const orderId = generateNextOrderID(); 

                const newOrder = {
                    id: orderId,
                    userId: this.userId,
                    userName: `User ${this.userId.substring(3, 7)}`, // Mock user name from local ID
                    items: this.cart.map(item => ({ 
                        id: item.id, 
                        name: item.name, 
                        price: item.price, 
                        qty: item.qty 
                    })),
                    total: parseFloat(total.toFixed(2)),
                    status: 'pending', // Initial status
                    timestamp: Date.now(),
                    prepTimeMinutes: null,
                    estimatedReadyTime: null
                };

                this.orders.unshift(newOrder); // Add to the beginning for easier viewing
                this.saveOrders();

                this.cart = []; // Clear cart on success
                this.renderCart();
                this.renderOrderHistory(this.orders.filter(order => order.userId === this.userId));
                
                // Display the new order ID format in the success message
                this.showMessageBox(`Order ${orderId} placed successfully! The payment of ${CURRENCY_SYMBOL}${total.toFixed(2)} was simulated and processed. Check your status below.`);
            },
            
            // --- Feedback Logic (Student Side) ---

            submitFeedback(itemId, rating, comment) {
                if (!itemId || !rating || !comment) {
                    this.showMessageBox("Please select an item, a rating, and write a comment to submit feedback.");
                    return;
                }

                const newFeedback = {
                    id: generateUniqueId(),
                    userId: this.userId,
                    itemId: itemId,
                    rating: rating,
                    comment: comment,
                    timestamp: Date.now(),
                };

                this.feedback.unshift(newFeedback);
                this.saveFeedback();

                // Clear form and re-render
                document.getElementById('feedback-form').reset();
                this.renderFeedbackSection();

                this.showMessageBox(`Thank you for your feedback on ${this.menu.find(i => i.id === itemId)?.name}!`);
            },

            renderItemSelectorOptions() {
                let options = '<option value="" disabled selected>Select Item for Feedback</option>';
                this.menu.sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
                    options += `<option value="${item.id}">${item.name}</option>`;
                });
                return options;
            },
            
            renderSingleFeedbackItem(feedback) {
                const item = QuickBite.menu.find(i => i.id === feedback.itemId);
                const itemName = item ? item.name : 'Unknown Item';
                const date = new Date(feedback.timestamp).toLocaleDateString();
                const time = new Date(feedback.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const stars = '⭐'.repeat(feedback.rating) + '☆'.repeat(5 - feedback.rating);

                return `
                    <div class="p-4 border border-gray-100 rounded-xl bg-white shadow-sm transition-all-smooth hover:shadow-md">
                        <div class="flex justify-between items-center text-sm">
                            <span class="font-bold text-gray-800">${itemName}</span>
                            <span class="text-canteen-primary">${stars}</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-2">Submitted on ${date} at ${time}</p>
                        <p class="text-sm text-gray-700 italic">${feedback.comment || 'No comment provided.'}</p>
                    </div>
                `;
            },
            // --- END Feedback Logic ---


            // --- Staff Side Logic (Order Updates) ---

            showPrepTimeModal(orderId) {
                document.getElementById('modalOrderId').value = orderId;
                // Display the full 8-digit order ID
                document.getElementById('modalOrderIdDisplay').textContent = orderId;
                document.getElementById('prepTimeInput').value = '';
                document.getElementById('prepTimeModal').classList.remove('hidden');
                document.getElementById('prepTimeModal').classList.add('flex');
            },

            hidePrepTimeModal() {
                document.getElementById('prepTimeModal').classList.add('hidden');
                document.getElementById('prepTimeModal').classList.remove('flex');
            },

            handlePrepTimeSubmission() {
                const orderId = document.getElementById('modalOrderId').value;
                const minutes = parseInt(document.getElementById('prepTimeInput').value, 10);
                
                if (orderId && minutes > 0) {
                    this.setOrderPrepTime(orderId, minutes);
                    this.hidePrepTimeModal();
                } else {
                    this.showMessageBox("Please enter a valid preparation time in minutes.");
                }
            },

            setOrderPrepTime(orderId, minutes) {
                const orderIndex = this.orders.findIndex(o => o.id === orderId);
                if (orderIndex === -1) return;

                const readyTime = new Date(Date.now() + minutes * 60000);
                
                this.orders[orderIndex] = {
                    ...this.orders[orderIndex],
                    status: 'in_preparation',
                    prepTimeMinutes: minutes,
                    estimatedReadyTime: readyTime.toISOString()
                };

                this.saveOrders();
                // Re-render staff view
                this.renderOrderQueue(this.orders.filter(order => order.status !== 'picked_up'));
            },

            markOrderReady(orderId) {
                const orderIndex = this.orders.findIndex(o => o.id === orderId);
                if (orderIndex === -1) return;

                this.orders[orderIndex].status = 'ready_for_pickup';

                this.saveOrders();
                // Re-render staff view
                this.renderOrderQueue(this.orders.filter(order => order.status !== 'picked_up'));
            },

            markOrderPickedUp(orderId) {
                const orderIndex = this.orders.findIndex(o => o.id === orderId);
                if (orderIndex === -1) return;

                this.orders[orderIndex].status = 'picked_up';

                this.saveOrders();
                // Re-render staff view
                this.renderOrderQueue(this.orders.filter(order => order.status !== 'picked_up'));
            },
            
            // --- Menu Management Logic (Staff Side) ---
            
            addNewMenuItem() {
                const form = document.getElementById('new-menu-item-form');
                const name = document.getElementById('new-item-name').value.trim();
                const price = parseFloat(document.getElementById('new-item-price').value);
                const description = document.getElementById('new-item-description').value.trim();
                const category = document.getElementById('new-item-category').value.trim();
                const imageUrl = document.getElementById('new-item-image-url').value.trim() || 'https://placehold.co/100x100/94A3B8/ffffff?text=New+Item';

                if (!name || isNaN(price) || price <= 0 || !description || !category) {
                    this.showMessageBox("Please fill in all required fields (Name, Price, Description, Category) with valid data.");
                    return;
                }
                
                // Simple ID generation for new item (using menu length for a somewhat unique ID)
                const newItemId = 'm' + (this.menu.length + 1);

                const newItem = {
                    id: newItemId,
                    name: name,
                    price: parseFloat(price.toFixed(2)),
                    description: description,
                    category: category,
                    imageUrl: imageUrl,
                    isAvailable: true // New items are available by default
                };

                this.menu.push(newItem);
                this.saveMenu(); // Save to Local Storage

                form.reset(); // Clear the form
                this.showMessageBox(`Menu item **${name}** added successfully!`);
                
                // Re-render the app to update both Staff (forms, lists) and Student (menu) views
                this.renderApp(); 
            },

            // NEW FUNCTION: Toggle item availability
            toggleItemAvailability(itemId) {
                const itemIndex = this.menu.findIndex(i => i.id === itemId);
                if (itemIndex === -1) return;

                this.menu[itemIndex].isAvailable = !this.menu[itemIndex].isAvailable;
                this.saveMenu();
                
                const status = this.menu[itemIndex].isAvailable ? 'AVAILABLE' : 'SOLD OUT';
                this.showMessageBox(`**${this.menu[itemIndex].name}** is now marked as **${status}**.`);
                
                // Re-render staff menu management and student menu/cart
                this.renderApp(); 
            },


            // --- Menu Filter Logic ---

            getUniqueCategories() {
                const categories = new Set();
                this.menu.forEach(item => categories.add(item.category));
                return Array.from(categories).sort();
            },

            populateCategoryFilter() {
                const filterSelect = document.getElementById('menu-category-filter');
                if (!filterSelect) return;

                const categories = this.getUniqueCategories();
                // Clear existing options except "All Categories"
                filterSelect.innerHTML = '<option value="all">All Categories</option>';

                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    filterSelect.appendChild(option);
                });
            },

            filterAndRenderMenu() {
                const searchInput = document.getElementById('menu-search-input');
                const categoryFilter = document.getElementById('menu-category-filter');

                if (!searchInput || !categoryFilter) return;

                const searchTerm = searchInput.value.toLowerCase().trim();
                const selectedCategory = categoryFilter.value;

                let filteredMenu = this.menu.filter(item => {
                    // 1. Category Filter
                    const categoryMatch = selectedCategory === 'all' || item.category === selectedCategory;

                    // 2. Search Term Filter
                    const searchMatch = !searchTerm || 
                        item.name.toLowerCase().includes(searchTerm) ||
                        item.description.toLowerCase().includes(searchTerm) ||
                        item.category.toLowerCase().includes(searchTerm);

                    return categoryMatch && searchMatch;
                });

                this.renderMenu(filteredMenu);
            },

            // --- Rendering Functions ---

            renderApp() {
                const mainArea = document.getElementById('main-content-area');
                mainArea.innerHTML = ''; // Clear content
                
                // --- Handle Navigation Link Visibility ---
                const menuLink = document.getElementById('nav-menu-link');
                if (menuLink) {
                    if (this.userRole === 'student') {
                        menuLink.classList.remove('hidden');
                    } else {
                        menuLink.classList.add('hidden');
                    }
                }
                // --- End Navigation Link Visibility ---
                
                if (this.userRole === 'student') {
                    mainArea.classList.add('lg:grid-cols-3');
                    mainArea.classList.remove('lg:grid-cols-1');
                    this.renderStudentView(mainArea);
                    this.populateCategoryFilter();
                    this.filterAndRenderMenu(); // Use filter and render function
                    this.renderCart();
                    this.renderFullMenuList(); 
                    // Filter orders relevant to the current user
                    const studentOrders = this.orders.filter(order => order.userId === this.userId);
                    this.renderOrderHistory(studentOrders);
                    this.renderFeedbackSection(); 
                } else {
                    mainArea.classList.add('lg:grid-cols-1');
                    mainArea.classList.remove('lg:grid-cols-3');
                    this.renderStaffView(mainArea);
                    // Filter active orders for staff
                    const staffOrders = this.orders.filter(order => order.status !== 'picked_up');
                    this.renderOrderQueue(staffOrders);
                }
                lucide.createIcons(); // Re-render icons after content update
            },

            renderStudentView(container) {
                // The main content area uses grid and gap-6, which already provides the layout.
                container.innerHTML = `
                    <div class="lg:col-span-2">
                        <div id="student-menu-section" class="bg-white p-6 rounded-2xl shadow-xl h-full transition-all-smooth">
                            <h2 class="text-3xl font-extrabold text-gray-800 mb-6">Canteen Menu</h2>
                            
                            <div class="p-4 bg-gray-50 rounded-xl shadow-inner mb-6 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 border border-gray-200">
                                <input type="text" id="menu-search-input" oninput="QuickBite.filterAndRenderMenu()" placeholder="Search items, descriptions, or categories..."
                                    class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-2 focus-canteen-primary focus:border-canteen-primary shadow-sm text-base transition-all-smooth">
                                
                                <select id="menu-category-filter" onchange="QuickBite.filterAndRenderMenu()"
                                        class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus-canteen-primary focus:border-canteen-primary bg-white shadow-sm text-base sm:w-1/3 transition-all-smooth">
                                    <option value="all">All Categories</option>
                                </select>
                            </div>

                            <div id="menu-list" class="space-y-4">
                                <p class="text-center text-gray-500 p-8">Loading menu...</p>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-1 space-y-8">
                        <div class="bg-white p-6 rounded-2xl shadow-xl transition-all-smooth">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Your Cart</h2>
                            <div id="cart-list" class="space-y-3 mb-6">
                                <p class="text-center text-gray-500">Cart is empty.</p>
                            </div>
                            <div class="flex justify-between items-center border-t border-gray-200 pt-4 mt-4">
                                <span class="text-xl font-bold">Total:</span>
                                <span id="cart-total" class="text-2xl font-extrabold text-canteen-primary">${CURRENCY_SYMBOL}0.00</span>
                            </div>
                            <button onclick="QuickBite.placeOrder()" 
                                    class="w-full mt-5 canteen-primary hover-canteen-primary text-white font-extrabold py-3 px-4 rounded-xl transition-all-smooth shadow-xl hover:shadow-2xl transform hover:scale-[1.01] ring-2 ring-transparent hover:ring-white/50">
                                Place Order Now
                            </button>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-xl transition-all-smooth">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Order Status</h2>
                            <div id="order-history" class="space-y-4 max-h-80 overflow-y-auto pr-2">
                                <p class="text-center text-gray-500">No orders placed yet.</p>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-2xl shadow-xl transition-all-smooth">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Food Feedback</h2>
                            <div id="feedback-section">
                                </div>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-3">
                        <div class="bg-white p-6 rounded-2xl shadow-xl transition-all-smooth">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Complete Menu Reference</h2>
                            <div id="complete-menu-list" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 p-2">
                                </div>
                        </div>
                    </div>
                `;
            },

            renderFeedbackSection() { 
                const container = document.getElementById('feedback-section');
                if (!container) return;

                // Filter feedback for the current user
                const userFeedback = this.feedback
                    .filter(f => f.userId === this.userId)
                    .sort((a, b) => b.timestamp - a.timestamp);

                container.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Submit Your Review</h3>
                    <form id="feedback-form" class="space-y-4 p-4 bg-gray-50 rounded-xl shadow-inner border border-gray-200">
                        <select id="feedback-item-id" required
                                class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus-canteen-primary focus:border-canteen-primary text-sm transition-all-smooth">
                            ${this.renderItemSelectorOptions()}
                        </select>

                        <div class="flex space-x-3 items-center">
                            <label class="text-sm font-medium text-gray-600 flex-shrink-0">Quality Rating:</label>
                            <select id="feedback-rating" required
                                    class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus-canteen-primary focus:border-canteen-primary text-sm w-full transition-all-smooth">
                                <option value="" disabled selected>Select Rating (1-5)</option>
                                <option value="5">5 - Excellent (Highly Recommend)</option>
                                <option value="4">4 - Good (Satisfied)</option>
                                <option value="3">3 - Average (Room for Improvement)</option>
                                <option value="2">2 - Poor (Needs Attention)</option>
                                <option value="1">1 - Very Bad (Unacceptable)</option>
                            </select>
                        </div>
                        
                        <textarea id="feedback-comment" rows="3" placeholder="Describe your experience (Taste, portion size, quality, etc.). Max 300 chars."
                                  class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus-canteen-primary focus:border-canteen-primary text-sm resize-none transition-all-smooth" maxlength="300"></textarea>
                        
                        <button type="submit" 
                                class="w-full canteen-primary hover-canteen-primary text-white font-bold py-3 rounded-xl transition-all-smooth shadow-md hover:shadow-lg transform hover:scale-[1.01]">
                            Send Feedback
                        </button>
                    </form>

                    <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-3 border-b pb-2">Your Past Reviews</h3>
                    <div id="user-feedback-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                        ${userFeedback.length > 0 
                            ? userFeedback.map(this.renderSingleFeedbackItem).join('')
                            : '<p class="text-center text-gray-500 text-sm p-4">You have not submitted any feedback yet.</p>'
                        }
                    </div>
                `;

                // Attach submit event listener
                document.getElementById('feedback-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const itemId = document.getElementById('feedback-item-id').value;
                    const rating = parseInt(document.getElementById('feedback-rating').value, 10);
                    const comment = document.getElementById('feedback-comment').value.trim();
                    QuickBite.submitFeedback(itemId, rating, comment);
                });
                lucide.createIcons();
            },

            renderStaffView(container) {
                container.innerHTML = `
                    <div class="bg-white p-8 rounded-2xl shadow-xl mb-8">
                        <h2 class="text-3xl font-extrabold text-gray-800 mb-6 flex items-center space-x-3 border-b pb-3">
                            <i data-lucide="bell-ring" class="w-7 h-7 text-canteen-primary"></i>
                            <span>Active Order Queue (Staff View)</span>
                        </h2>
                        <div id="order-queue" class="space-y-5">
                            <p class="text-center text-gray-500">No active orders.</p>
                        </div>
                    </div>
                    
                    <div class="bg-white p-8 rounded-2xl shadow-xl mb-8">
                        <h2 class="text-3xl font-extrabold text-gray-800 mb-6 flex items-center space-x-3 border-b pb-3">
                            <i data-lucide="folder-plus" class="w-7 h-7 text-canteen-primary"></i>
                            <span>Menu Item Management</span>
                        </h2>
                        <form id="new-menu-item-form" class="space-y-4 p-6 bg-gray-50 rounded-xl shadow-inner border border-gray-200 mb-8">
                            <h3 class="text-xl font-bold text-gray-700">Add New Item</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input type="text" id="new-item-name" placeholder="Item Name (e.g., Masala Chai)" required 
                                    class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus-canteen-primary focus:border-canteen-primary transition-all-smooth">
                                <input type="number" id="new-item-price" placeholder="Price (e.g., 50.00)" required min="0.01" step="0.01"
                                    class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus-canteen-primary focus:border-canteen-primary transition-all-smooth">
                            </div>

                            <input type="text" id="new-item-category" placeholder="Category (e.g., Drinks, Snacks, Meals)" required
                                class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus-canteen-primary focus:border-canteen-primary transition-all-smooth">
                                
                            <textarea id="new-item-description" rows="2" placeholder="Short Description..." required
                                class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus-canteen-primary focus:border-canteen-primary resize-none transition-all-smooth"></textarea>

                            <input type="url" id="new-item-image-url" placeholder="Image URL (optional)"
                                class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus-canteen-primary focus:border-canteen-primary transition-all-smooth">
                                
                            <button type="submit" 
                                    class="w-full canteen-primary hover-canteen-primary text-white font-bold py-3 rounded-xl transition-all-smooth shadow-md hover:shadow-lg transform hover:scale-[1.01] flex items-center justify-center space-x-2">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                <span>Add Item to Menu</span>
                            </button>
                        </form>
                        
                        <div class="mt-8 border-t border-gray-200 pt-6">
                            <h3 class="text-xl font-bold text-gray-700 mb-4">Item Availability Status</h3>
                            <div id="menu-status-list" class="space-y-3">
                                ${this.renderMenuStatusList()}
                            </div>
                        </div>

                    </div>
                    <div class="bg-white p-8 rounded-2xl shadow-xl">
                        <h2 class="text-3xl font-extrabold text-gray-800 mb-6 flex items-center space-x-3 border-b pb-3">
                            <i data-lucide="message-square-text" class="w-7 h-7 text-canteen-primary"></i>
                            <span>Customer Feedback Review (${this.feedback.length})</span>
                        </h2>
                        <div id="feedback-review-list" class="space-y-4 max-h-[50vh] overflow-y-auto pr-2">
                            ${this.renderStaffFeedbackList()}
                        </div>
                    </div>
                `;
                
                // Attach submit event listener for the new form
                const newItemForm = document.getElementById('new-menu-item-form');
                if (newItemForm) {
                    newItemForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        QuickBite.addNewMenuItem();
                    });
                }
                
                lucide.createIcons(); // Re-render icons for staff view
            },
            
            // NEW FUNCTION: Render the availability list for staff
            renderMenuStatusList() {
                 if (this.menu.length === 0) {
                     return '<p class="text-center text-gray-500 mt-4">The menu is empty.</p>';
                 }

                 // Sort by category, then name
                 const sortedMenu = [...this.menu].sort((a, b) => {
                     if (a.category < b.category) return -1;
                     if (a.category > b.category) return 1;
                     return a.name.localeCompare(b.name);
                 });

                 return sortedMenu.map(item => {
                     const isAvailable = item.isAvailable;
                     const statusText = isAvailable ? 'Available' : 'Sold Out';
                     const statusClass = isAvailable ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600';
                     const buttonIcon = isAvailable ? 'toggle-right' : 'toggle-left';
                     const buttonTitle = isAvailable ? 'Mark as Sold Out' : 'Mark as Available';
                     
                     return `
                         <div class="flex justify-between items-center p-4 border border-gray-200 rounded-xl bg-white shadow-sm">
                             <div class="flex-1 min-w-0">
                                 <p class="font-semibold text-gray-800 truncate">${item.name}</p>
                                 <p class="text-xs text-gray-500">${item.category}</p>
                             </div>
                             
                             <div class="flex items-center space-x-4">
                                 <span class="text-sm font-bold ${isAvailable ? 'text-green-600' : 'text-red-600'}">${statusText}</span>
                                 <button onclick="QuickBite.toggleItemAvailability('${item.id}')"
                                         title="${buttonTitle}"
                                         class="text-white p-2 rounded-full ${statusClass} transition-all-smooth transform hover:scale-105 active:scale-95">
                                     <i data-lucide="${buttonIcon}" class="w-5 h-5"></i>
                                 </button>
                             </div>
                         </div>
                     `;
                 }).join('');
            },

            renderStaffFeedbackList() { 
                if (this.feedback.length === 0) {
                    return '<p class="text-center text-gray-500 mt-4">No feedback has been submitted yet.</p>';
                }

                // Sort by newest first
                const sortedFeedback = [...this.feedback].sort((a, b) => b.timestamp - a.timestamp);

                return sortedFeedback.map(feedback => {
                    const item = this.menu.find(i => i.id === feedback.itemId);
                    const itemName = item ? item.name : 'Unknown Item';
                    const date = new Date(feedback.timestamp).toLocaleDateString();
                    const time = new Date(feedback.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const stars = '⭐'.repeat(feedback.rating) + '☆'.repeat(5 - feedback.rating);
                    // Use a mock user name based on the local ID snippet
                    const userNameDisplay = `User ${feedback.userId.substring(3, 7)}`; 

                    return `
                        <div class="p-4 border border-gray-200 rounded-xl bg-gray-50 shadow-md">
                            <div class="flex justify-between items-center text-base mb-1">
                                <span class="font-bold text-gray-800">${itemName}</span>
                                <span class="text-canteen-primary font-semibold">${stars}</span>
                            </div>
                            <p class="text-xs text-gray-500 mb-3 border-b border-gray-200 pb-1">By <span class="font-medium text-gray-700">${userNameDisplay}</span> on ${date} at ${time}</p>
                            <p class="text-sm text-gray-700 italic border-l-4 border-amber-400 pl-3">${feedback.comment || 'No comment provided.'}</p>
                        </div>
                    `;
                }).join('');
            },

            // --- Student View Sub-Renderers ---

            renderMenu(filteredMenu) {
                const menuList = document.getElementById('menu-list');
                if (!menuList) return;
                
                const menuToRender = filteredMenu || this.menu;

                if (menuToRender.length === 0) {
                    menuList.innerHTML = '<p class="text-center text-gray-500 p-8">No menu items match your search criteria.</p>';
                    return;
                }

                // Note: The main menu list allows adding to cart
                menuList.innerHTML = menuToRender.map(item => {
                    const isAvailable = item.isAvailable;
                    const availabilityOverlay = isAvailable ? '' : `
                        <div class="absolute inset-0 bg-red-600 bg-opacity-70 flex items-center justify-center rounded-2xl">
                            <span class="text-white text-xl font-extrabold rotate-[-10deg] p-4 border-4 border-white rounded-lg shadow-xl">SOLD OUT</span>
                        </div>
                    `;
                    const buttonHtml = isAvailable ? `
                        <button onclick="QuickBite.addToCart('${item.id}')"
                                class="p-2.5 rounded-full canteen-primary text-white hover-canteen-primary transition-all-smooth shadow-md hover:shadow-lg flex-shrink-0 transform hover:scale-110 active:scale-95 ring-2 ring-transparent hover:ring-white/50">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    ` : `
                        <button disabled title="Currently Sold Out"
                                class="p-2.5 rounded-full bg-gray-400 text-gray-100 cursor-not-allowed shadow-inner flex-shrink-0">
                            <i data-lucide="minus-circle" class="w-5 h-5"></i>
                        </button>
                    `;


                    return `
                        <div class="relative flex flex-col sm:flex-row justify-between items-center p-5 border ${isAvailable ? 'border-gray-200' : 'border-red-400'} rounded-2xl bg-white hover:bg-gray-50 transition-all-smooth shadow-lg hover:shadow-xl transform hover:scale-[1.005] ${isAvailable ? '' : 'opacity-70'}">
                            
                            <div class="flex items-center space-x-4 flex-grow min-w-0 mb-3 sm:mb-0">
                                <div class="w-16 h-16 rounded-lg overflow-hidden flex-shrink-0 border-2 border-canteen-primary/20">
                                    <img src="${item.imageUrl}" 
                                         alt="${item.name}" 
                                         class="w-full h-full object-cover" 
                                         onerror="this.onerror=null; this.classList.add('img-fallback'); this.src='https://placehold.co/100x100/A3E635/166534?text=${item.name.split(' ')[0]}';"
                                    >
                                </div>
                                
                                <div class="min-w-0 flex-grow">
                                    <p class="text-lg font-extrabold text-gray-800 truncate">${item.name} 
                                        <span class="text-sm font-medium text-gray-500">(${item.category})</span>
                                    </p>
                                    <p class="text-sm text-gray-600 truncate">${item.description}</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-6 flex-shrink-0">
                                <span class="text-xl font-bold text-canteen-primary">${CURRENCY_SYMBOL}${item.price.toFixed(2)}</span>
                                ${buttonHtml}
                            </div>
                            ${availabilityOverlay}
                        </div>
                    `;
                }).join('');
                lucide.createIcons(); // Re-render icons
            },

            renderFullMenuList() {
                const completeList = document.getElementById('complete-menu-list');
                if (!completeList) return;

                // Sort by Category, then by Name
                const sortedMenu = [...this.menu].sort((a, b) => {
                    if (a.category < b.category) return -1;
                    if (a.category > b.category) return 1;
                    if (a.name < b.name) return -1;
                    if (a.name > b.name) return 1;
                    return 0;
                });

                // Group by category for better display
                const groupedMenu = sortedMenu.reduce((acc, item) => {
                    acc[item.category] = acc[item.category] || [];
                    acc[item.category].push(item);
                    return acc;
                }, {});

                let htmlContent = '';
                for (const category in groupedMenu) {
                    htmlContent += `
                        <div class="p-4 border border-gray-200 rounded-xl bg-gray-50 shadow-md transition-all-smooth hover:shadow-lg">
                            <h3 class="text-lg font-bold text-canteen-primary border-b border-gray-300 pb-2 mb-3">${category}</h3>
                            <ul class="space-y-2">
                                ${groupedMenu[category].map(item => {
                                    const isAvailable = item.isAvailable;
                                    const buttonHtml = isAvailable ? `
                                        <button onclick="QuickBite.addToCart('${item.id}')"
                                                title="Add to Cart"
                                                class="ml-3 p-1.5 rounded-full bg-yellow-500 text-white hover:bg-yellow-600 transition-all-smooth shadow-sm flex-shrink-0 transform hover:scale-110 active:scale-95">
                                            <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                                        </button>
                                    ` : `
                                        <span class="text-red-500 font-bold text-xs ml-3">SOLD OUT</span>
                                    `;

                                    return `
                                        <li class="flex justify-between items-center text-sm py-1 ${isAvailable ? '' : 'opacity-60'}">
                                            <div class="flex-grow">
                                                <span class="text-gray-700 font-medium">${item.name}</span>
                                                <span class="font-semibold text-gray-800 block sm:inline">${CURRENCY_SYMBOL}${item.price.toFixed(2)}</span>
                                            </div>
                                            
                                            ${buttonHtml}
                                        </li>
                                    `;
                                }).join('')}
                            </ul>
                        </div>
                    `;
                }

                completeList.innerHTML = htmlContent;
                lucide.createIcons(); // Re-render icons
            },


            renderCart() {
                const cartList = document.getElementById('cart-list');
                const cartTotal = document.getElementById('cart-total');
                if (!cartList || !cartTotal) return;

                if (this.cart.length === 0) {
                    cartList.innerHTML = '<p class="text-center text-gray-500">Cart is empty.</p>';
                    cartTotal.textContent = `${CURRENCY_SYMBOL}0.00`;
                    return;
                }

                const total = this.cart.reduce((sum, item) => sum + item.price * item.qty, 0);

                cartList.innerHTML = this.cart.map(item => {
                    const menuItem = this.menu.find(m => m.id === item.id);
                    const isAvailable = menuItem && menuItem.isAvailable;
                    
                    const itemClass = isAvailable ? 'bg-gray-50' : 'bg-red-50 border-red-400 opacity-80';
                    const nameClass = isAvailable ? 'text-gray-700' : 'text-red-600 line-through';
                    
                    const buttonHtml = isAvailable ? `
                        <button onclick="QuickBite.updateCartItem('${item.id}', -1)"
                                class="text-red-500 hover:bg-red-100 rounded-full p-1 transition">
                            <i data-lucide="minus" class="w-4 h-4"></i>
                        </button>
                        <span class="font-bold w-4 text-center text-lg text-gray-800">${item.qty}</span>
                        <button onclick="QuickBite.updateCartItem('${item.id}', 1)"
                                class="text-canteen-primary hover:bg-emerald-100 rounded-full p-1 transition">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    ` : `
                        <span class="text-red-600 font-semibold text-xs text-right w-20">SOLD OUT</span>
                    `;
                    
                    return `
                        <div class="flex justify-between items-center p-3 ${itemClass} rounded-lg border border-gray-200">
                            <div class="flex-grow">
                                <span class="font-semibold ${nameClass}">${item.name}</span>
                                <span class="text-xs text-gray-500">(${CURRENCY_SYMBOL}${item.price.toFixed(2)})</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${buttonHtml}
                            </div>
                            <span class="font-bold w-12 text-right text-gray-900">${CURRENCY_SYMBOL}${(item.price * item.qty).toFixed(2)}</span>
                        </div>
                    `;
                }).join('');
                
                cartTotal.textContent = `${CURRENCY_SYMBOL}${total.toFixed(2)}`;
                lucide.createIcons();
            },

            renderOrderHistory(orders) {
                const historyList = document.getElementById('order-history');
                if (!historyList) return;

                if (orders.length === 0) {
                    historyList.innerHTML = '<p class="text-center text-gray-500">No orders placed yet.</p>';
                    return;
                }

                historyList.innerHTML = orders.sort((a, b) => b.timestamp - a.timestamp).map(order => {
                    const statusColors = {
                        pending: 'bg-yellow-100 text-yellow-800',
                        in_preparation: 'bg-blue-100 text-blue-800',
                        ready_for_pickup: 'bg-green-100 text-green-800 font-extrabold animate-pulse ring-2 ring-green-500', // Enhanced visibility
                        picked_up: 'bg-gray-100 text-gray-500'
                    };
                    const statusText = order.status.replace(/_/g, ' ');
                    const statusClass = statusColors[order.status] || 'bg-gray-200 text-gray-700';
                    
                    let timeInfo = '';
                    if (order.status === 'in_preparation' && order.estimatedReadyTime) {
                        const readyDate = new Date(order.estimatedReadyTime);
                        const timeStr = readyDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        timeInfo = `<p class="text-sm font-medium text-blue-600 mt-1">Ready by: ${timeStr} <i data-lucide="timer" class="w-4 h-4 inline-block ml-1"></i></p>`;
                    } else if (order.status === 'pending') {
                         timeInfo = `<p class="text-sm font-medium text-yellow-600 mt-1">Awaiting staff confirmation.</p>`;
                    }

                    return `
                        <div class="p-4 border border-gray-200 rounded-xl shadow-md transition-all-smooth hover:shadow-lg">
                            <div class="flex justify-between items-start">
                                <div class="font-bold text-gray-800 text-lg">Order #${order.id}</div> 
                                <span class="text-xs font-semibold px-3 py-1 rounded-full capitalize ${statusClass} transition-all-smooth">${statusText}</span>
                            </div>
                            <ul class="list-disc ml-4 text-sm text-gray-700 mt-3 space-y-1">
                                ${order.items.map(item => `<li><span class="font-medium">${item.qty}x</span> ${item.name}</li>`).join('')}
                            </ul>
                            <div class="flex justify-between items-center pt-3 mt-3 border-t border-gray-200">
                                <span class="text-base font-semibold">Total: <span class="font-extrabold text-canteen-primary">${CURRENCY_SYMBOL}${order.total.toFixed(2)}</span></span>
                                ${timeInfo}
                            </div>
                        </div>
                    `;
                }).join('');
                lucide.createIcons();
            },

            // --- Staff View Renderer ---

            renderOrderQueue(orders) {
                const queueList = document.getElementById('order-queue');
                if (!queueList) return;

                if (orders.length === 0) {
                    queueList.innerHTML = '<p class="text-center text-gray-500 mt-8 p-10 bg-gray-50 rounded-xl">Queue is empty! Enjoy the peace.</p>';
                    return;
                }

                // Sort by oldest (smallest timestamp) first
                queueList.innerHTML = orders.sort((a, b) => a.timestamp - b.timestamp).map(order => {
                    const isPending = order.status === 'pending';
                    const isInPrep = order.status === 'in_preparation';
                    const isReady = order.status === 'ready_for_pickup';

                    let actions = '';
                    if (isPending) {
                        actions = `
                            <button onclick="QuickBite.showPrepTimeModal('${order.id}')" 
                                    class="bg-amber-500 hover:bg-amber-600 text-white text-sm font-semibold py-2 px-4 rounded-xl transition-all-smooth shadow-md flex items-center space-x-1 transform hover:scale-[1.02]">
                                <i data-lucide="clock" class="w-4 h-4"></i>
                                <span>Set Prep Time</span>
                            </button>
                        `;
                    } else if (isInPrep) {
                        actions = `
                            <button onclick="QuickBite.markOrderReady('${order.id}')" 
                                    class="bg-green-600 hover:bg-green-700 text-white text-sm font-semibold py-2 px-4 rounded-xl transition-all-smooth shadow-md flex items-center space-x-1 transform hover:scale-[1.02]">
                                <i data-lucide="check-circle" class="w-4 h-4"></i>
                                <span>Mark Ready</span>
                            </button>
                        `;
                    } else if (isReady) {
                         actions = `
                            <button onclick="QuickBite.markOrderPickedUp('${order.id}')" 
                                    class="bg-gray-700 hover:bg-gray-800 text-white text-sm font-semibold py-2 px-4 rounded-xl transition-all-smooth shadow-md flex items-center space-x-1 transform hover:scale-[1.02]">
                                <i data-lucide="archive" class="w-4 h-4"></i>
                                <span>Mark Picked Up</span>
                            </button>
                        `;
                    }

                    const statusColors = {
                        pending: 'border-yellow-500 bg-yellow-50 text-yellow-800',
                        in_preparation: 'border-blue-500 bg-blue-50 text-blue-800',
                        ready_for_pickup: 'border-green-500 bg-green-50 text-green-800',
                        picked_up: 'border-gray-400 bg-gray-100 text-gray-500'
                    };
                    const statusClass = statusColors[order.status] || 'border-gray-300 bg-gray-100';

                    let prepTimeInfo = '';
                    if (order.status === 'in_preparation' && order.prepTimeMinutes) {
                        const readyDate = new Date(order.estimatedReadyTime);
                        prepTimeInfo = `<p class="text-sm font-medium text-blue-700 mt-2">Est. Ready: ${readyDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} (${order.prepTimeMinutes} mins)</p>`;
                    }


                    return `
                        <div class="border-l-4 ${statusClass} rounded-xl shadow-lg p-5 flex flex-col md:flex-row justify-between items-start md:items-center bg-white transition-all-smooth hover:shadow-xl">
                            <div class="flex-1 min-w-0 mb-4 md:mb-0">
                                <div class="flex items-center space-x-3 mb-2">
                                    <h3 class="text-xl font-bold text-gray-800">Order #${order.id}</h3>
                                    <span class="text-sm font-medium text-gray-500">(${order.userName})</span>
                                </div>
                                
                                <ul class="list-disc ml-6 text-sm text-gray-700 space-y-1">
                                    ${order.items.map(item => `<li><span class="font-semibold">${item.qty}x</span> ${item.name}</li>`).join('')}
                                </ul>
                                
                                <div class="mt-3 text-sm text-gray-600 border-t border-gray-100 pt-2">
                                    <p class="font-semibold">Total: <span class="font-extrabold text-canteen-primary">${CURRENCY_SYMBOL}${order.total.toFixed(2)}</span></p>
                                    ${prepTimeInfo}
                                </div>
                            </div>
                            
                            <div class="md:ml-4 flex-shrink-0">
                                ${actions}
                            </div>
                        </div>
                    `;
                }).join('');
                lucide.createIcons();
            }

        };

        // Initialize the application when the window loads
        window.onload = function() {
            QuickBite.initApp();
        };

    </script>
</body>
</html>